<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Page Notification Test</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #logs { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .test-section { border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Real Page Notification Test</h1>
    <p>This page tests notifications on the actual prayer-time.html page with the same setup.</p>
    
    <div id="status" class="status info">Initializing...</div>
    
    <div class="test-section">
        <h3>1. Permission & Service Worker Test</h3>
        <button onclick="checkPermission()">Check Notification Permission</button>
        <button onclick="registerSW()">Register Service Worker</button>
        <button onclick="testServiceWorker()">Test Service Worker Communication</button>
    </div>
    
    <div class="test-section">
        <h3>2. Direct Notification Test</h3>
        <button onclick="sendDirectNotification()">Send Direct Notification</button>
        <button onclick="sendTestPushMessage()">Send Test Push Message</button>
    </div>
    
    <div class="test-section">
        <h3>3. Server API Test</h3>
        <button onclick="testServerAPI()">Test Server Notification API</button>
        <button onclick="testPrayerNotification()">Test Prayer Notification</button>
    </div>
    
    <div class="test-section">
        <h3>4. Real Page Simulation</h3>
        <button onclick="simulatePrayerTimePage()">Simulate Prayer Time Page</button>
        <button onclick="testNotificationButtons()">Test Notification Buttons</button>
    </div>
    
    <button onclick="clearLogs()">Clear Logs</button>
    <div id="logs"></div>

    <script>
        const statusEl = document.getElementById('status');
        const logsEl = document.getElementById('logs');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logsEl.innerHTML += `[${timestamp}] ${message}\n`;
            logsEl.scrollTop = logsEl.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function clearLogs() {
            logsEl.innerHTML = '';
        }
        
        async function checkPermission() {
            log('üîç Checking notification permission...');
            
            if (!('Notification' in window)) {
                updateStatus('‚ùå Notifications not supported', 'error');
                log('‚ùå Notifications not supported in this browser');
                return;
            }
            
            const permission = Notification.permission;
            log(`üì± Current permission: ${permission}`);
            
            if (permission === 'granted') {
                updateStatus('‚úÖ Notification permission granted', 'success');
                log('‚úÖ Notification permission is granted');
            } else if (permission === 'denied') {
                updateStatus('‚ùå Notification permission denied', 'error');
                log('‚ùå Notification permission is denied');
            } else {
                updateStatus('‚ö†Ô∏è Requesting notification permission...', 'info');
                const result = await Notification.requestPermission();
                log(`üì± Permission result: ${result}`);
                if (result === 'granted') {
                    updateStatus('‚úÖ Notification permission granted', 'success');
                } else {
                    updateStatus('‚ùå Notification permission denied', 'error');
                }
            }
        }
        
        async function registerSW() {
            log('üîß Registering Service Worker...');
            
            if (!('serviceWorker' in navigator)) {
                updateStatus('‚ùå Service Worker not supported', 'error');
                log('‚ùå Service Workers are not supported in this browser');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.register('/sw.js');
                log('‚úÖ Service Worker registered successfully');
                log(`üì± Registration scope: ${registration.scope}`);
                log(`üì± Registration active: ${registration.active ? 'Yes' : 'No'}`);
                
                // Listen for Service Worker messages
                navigator.serviceWorker.addEventListener('message', event => {
                    log(`üì® SW Message: ${JSON.stringify(event.data)}`);
                });
                
                updateStatus('‚úÖ Service Worker registered', 'success');
                
                // Check if Service Worker is controlling the page
                if (navigator.serviceWorker.controller) {
                    log('‚úÖ Service Worker is controlling this page');
                } else {
                    log('‚ö†Ô∏è Service Worker is not controlling this page yet');
                }
                
            } catch (error) {
                updateStatus('‚ùå Service Worker registration failed', 'error');
                log(`‚ùå Service Worker registration failed: ${error.message}`);
                console.error('Service Worker registration failed:', error);
            }
        }
        
        async function testServiceWorker() {
            log('üß™ Testing Service Worker communication...');
            
            if (!navigator.serviceWorker.controller) {
                log('‚ùå Service Worker not controlling page');
                return;
            }
            
            try {
                navigator.serviceWorker.controller.postMessage({
                    type: 'TEST_PUSH',
                    data: {
                        title: 'üß™ SW Communication Test',
                        body: 'Testing Service Worker message handling!',
                        icon: '/icons/icon-192x192.png',
                        tag: 'sw-communication-test',
                        requireInteraction: true,
                        data: {
                            notificationId: 'sw-test-' + Date.now(),
                            type: 'test'
                        }
                    }
                });
                
                log('‚úÖ Test message sent to Service Worker');
                
            } catch (error) {
                log(`‚ùå Failed to send test message: ${error.message}`);
                console.error('Failed to send test message:', error);
            }
        }
        
        async function sendDirectNotification() {
            log('üì§ Sending direct notification...');
            
            if (Notification.permission !== 'granted') {
                log('‚ùå Notification permission not granted');
                return;
            }
            
            try {
                const notification = new Notification('üéâ Direct Notification Test', {
                    body: 'This is a direct browser notification test!',
                    icon: '/icons/icon-192x192.png',
                    tag: 'direct-test',
                    requireInteraction: true
                });
                
                log('‚úÖ Direct notification created successfully');
                
                notification.onclick = () => {
                    log('üëÜ Direct notification clicked');
                    notification.close();
                };
                
            } catch (error) {
                log(`‚ùå Failed to create direct notification: ${error.message}`);
                console.error('Failed to create direct notification:', error);
            }
        }
        
        async function sendTestPushMessage() {
            log('üì§ Sending test push message to Service Worker...');
            
            if (!navigator.serviceWorker.controller) {
                log('‚ùå Service Worker not controlling page');
                return;
            }
            
            try {
                navigator.serviceWorker.controller.postMessage({
                    type: 'TEST_PUSH',
                    data: {
                        title: 'üöÄ Push Message Test',
                        body: 'Testing push message handling in Service Worker!',
                        icon: '/icons/icon-192x192.png',
                        tag: 'push-message-test',
                        requireInteraction: true,
                        data: {
                            notificationId: 'push-test-' + Date.now(),
                            type: 'test'
                        }
                    }
                });
                
                log('‚úÖ Test push message sent to Service Worker');
                
            } catch (error) {
                log(`‚ùå Failed to send push message: ${error.message}`);
                console.error('Failed to send push message:', error);
            }
        }
        
        async function testServerAPI() {
            log('üåê Testing server notification API...');
            
            try {
                const response = await fetch('/api/notifications/test-immediate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('accessToken') || 'test-token'}`
                    },
                    body: JSON.stringify({
                        title: 'üåê Server API Test',
                        body: 'Testing server notification API endpoint!',
                        icon: '/icons/icon-192x192.png'
                    })
                });
                
                const data = await response.json();
                log(`üì° Server response: ${JSON.stringify(data)}`);
                
                if (response.ok) {
                    log('‚úÖ Server API test successful');
                } else {
                    log(`‚ùå Server API test failed: ${data.message || 'Unknown error'}`);
                }
                
            } catch (error) {
                log(`‚ùå Server API test error: ${error.message}`);
                console.error('Server API test error:', error);
            }
        }
        
        async function testPrayerNotification() {
            log('üïå Testing prayer notification...');
            
            try {
                const response = await fetch('/api/notifications/test-prayer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('accessToken') || 'test-token'}`
                    },
                    body: JSON.stringify({
                        prayer: 'isha',
                        title: 'üïå Prayer Notification Test',
                        body: 'Testing prayer notification system!',
                        icon: '/icons/icon-192x192.png'
                    })
                });
                
                const data = await response.json();
                log(`üì° Prayer notification response: ${JSON.stringify(data)}`);
                
                if (response.ok) {
                    log('‚úÖ Prayer notification test successful');
                } else {
                    log(`‚ùå Prayer notification test failed: ${data.message || 'Unknown error'}`);
                }
                
            } catch (error) {
                log(`‚ùå Prayer notification test error: ${error.message}`);
                console.error('Prayer notification test error:', error);
            }
        }
        
        async function simulatePrayerTimePage() {
            log('üïå Simulating prayer time page setup...');
            
            // Simulate the same setup as prayer-time.html
            try {
                // Check if we have the same scripts loaded
                if (typeof window.tokenManager !== 'undefined') {
                    log('‚úÖ TokenManager found');
                } else {
                    log('‚ö†Ô∏è TokenManager not found - simulating...');
                }
                
                if (typeof window.prayerTimeAPI !== 'undefined') {
                    log('‚úÖ PrayerTimeAPI found');
                } else {
                    log('‚ö†Ô∏è PrayerTimeAPI not found - simulating...');
                }
                
                // Test notification permission
                await checkPermission();
                
                // Test Service Worker
                await registerSW();
                
                // Test direct notification
                await sendDirectNotification();
                
                log('‚úÖ Prayer time page simulation completed');
                
            } catch (error) {
                log(`‚ùå Prayer time page simulation error: ${error.message}`);
                console.error('Prayer time page simulation error:', error);
            }
        }
        
        async function testNotificationButtons() {
            log('üîò Testing notification buttons...');
            
            // Simulate clicking the notification buttons from prayer-time.html
            try {
                // Test 1: Test Notification button
                log('üîò Testing "Test Notification" button...');
                await sendTestPushMessage();
                
                // Test 2: Test Prayer Alert button
                log('üîò Testing "Test Prayer Alert" button...');
                await testPrayerNotification();
                
                log('‚úÖ Notification buttons test completed');
                
            } catch (error) {
                log(`‚ùå Notification buttons test error: ${error.message}`);
                console.error('Notification buttons test error:', error);
            }
        }
        
        // Auto-run on page load
        document.addEventListener('DOMContentLoaded', async () => {
            log('üöÄ Real page notification test loaded');
            log('üìã This page simulates the same setup as prayer-time.html');
            await checkPermission();
            await registerSW();
        });
    </script>
</body>
</html>
