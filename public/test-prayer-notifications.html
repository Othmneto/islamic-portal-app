<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prayer Notification Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .audio-controls {
            margin: 10px 0;
        }
        .audio-controls input[type="range"] {
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Prayer Notification Test Page</h1>
        <p>This page helps you test the prayer notification system and audio playback.</p>

        <!-- Notification Permission Test -->
        <div class="test-section">
            <h3>üì± Notification Permission</h3>
            <button id="request-permission">Request Notification Permission</button>
            <button id="check-permission">Check Permission Status</button>
            <div id="permission-status" class="status info">Click "Check Permission Status" to see current status</div>
        </div>

        <!-- Service Worker Test -->
        <div class="test-section">
            <h3>üîß Service Worker</h3>
            <button id="register-sw">Register Service Worker</button>
            <button id="check-sw">Check Service Worker Status</button>
            <div id="sw-status" class="status info">Click "Check Service Worker Status" to see current status</div>
        </div>

        <!-- Push Subscription Test -->
        <div class="test-section">
            <h3>üì° Push Subscription</h3>
            <button id="subscribe-push">Subscribe to Push Notifications</button>
            <button id="unsubscribe-push">Unsubscribe from Push Notifications</button>
            <button id="check-subscription">Check Subscription Status</button>
            <div id="subscription-status" class="status info">Click "Check Subscription Status" to see current status</div>
        </div>

        <!-- Test Notifications -->
        <div class="test-section">
            <h3>üîî Test Notifications</h3>
            <button id="test-basic">Test Basic Notification</button>
            <button id="test-prayer">Test Prayer Notification</button>
            <button id="test-reminder">Test Prayer Reminder</button>
            <div id="notification-status" class="status info">Click a test button to send a notification</div>
        </div>

        <!-- Audio Test -->
        <div class="test-section">
            <h3>üîä Audio Test</h3>
            <div class="audio-controls">
                <label>Volume: <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1"></label>
                <button id="test-audio">Test Audio Playback</button>
                <button id="stop-audio">Stop Audio</button>
            </div>
            <div id="audio-status" class="status info">Click "Test Audio Playback" to test adhan audio</div>
        </div>

        <!-- Log -->
        <div class="test-section">
            <h3>üìù Test Log</h3>
            <button id="clear-log">Clear Log</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- Audio element for testing -->
    <audio id="test-audio-player" src="/audio/adhan.mp3" preload="auto"></audio>

    <script>
        // Logging function
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333';
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Status update function
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // Request notification permission
        document.getElementById('request-permission').addEventListener('click', async () => {
            try {
                const permission = await Notification.requestPermission();
                updateStatus('permission-status', `Permission: ${permission}`, permission === 'granted' ? 'success' : 'error');
                log(`Notification permission: ${permission}`);
            } catch (error) {
                updateStatus('permission-status', `Error: ${error.message}`, 'error');
                log(`Error requesting permission: ${error.message}`, 'error');
            }
        });

        // Check notification permission
        document.getElementById('check-permission').addEventListener('click', () => {
            const permission = Notification.permission;
            updateStatus('permission-status', `Permission: ${permission}`, permission === 'granted' ? 'success' : 'error');
            log(`Current notification permission: ${permission}`);
        });

        // Register service worker
        document.getElementById('register-sw').addEventListener('click', async () => {
            try {
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    updateStatus('sw-status', 'Service Worker registered successfully', 'success');
                    log('Service Worker registered successfully');
                } else {
                    updateStatus('sw-status', 'Service Worker not supported', 'error');
                    log('Service Worker not supported', 'error');
                }
            } catch (error) {
                updateStatus('sw-status', `Error: ${error.message}`, 'error');
                log(`Error registering Service Worker: ${error.message}`, 'error');
            }
        });

        // Check service worker status
        document.getElementById('check-sw').addEventListener('click', async () => {
            try {
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        updateStatus('sw-status', 'Service Worker is registered and active', 'success');
                        log('Service Worker is registered and active');
                    } else {
                        updateStatus('sw-status', 'Service Worker not registered', 'error');
                        log('Service Worker not registered', 'error');
                    }
                } else {
                    updateStatus('sw-status', 'Service Worker not supported', 'error');
                    log('Service Worker not supported', 'error');
                }
            } catch (error) {
                updateStatus('sw-status', `Error: ${error.message}`, 'error');
                log(`Error checking Service Worker: ${error.message}`, 'error');
            }
        });

        // Subscribe to push notifications
        document.getElementById('subscribe-push').addEventListener('click', async () => {
            try {
                if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                    throw new Error('Push notifications not supported');
                }

                const registration = await navigator.serviceWorker.ready;
                const response = await fetch('/api/notifications/vapid-public-key');
                const vapidPublicKey = await response.text();
                
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                });

                // Send subscription to server
                const serverResponse = await fetch('/api/notifications/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subscription: subscription,
                        preferences: {
                            enabled: true,
                            perPrayer: { fajr: true, dhuhr: true, asr: true, maghrib: true, isha: true },
                            reminderMinutes: 10
                        }
                    })
                });

                if (serverResponse.ok) {
                    updateStatus('subscription-status', 'Successfully subscribed to push notifications', 'success');
                    log('Successfully subscribed to push notifications');
                } else {
                    throw new Error('Failed to subscribe on server');
                }
            } catch (error) {
                updateStatus('subscription-status', `Error: ${error.message}`, 'error');
                log(`Error subscribing to push notifications: ${error.message}`, 'error');
            }
        });

        // Unsubscribe from push notifications
        document.getElementById('unsubscribe-push').addEventListener('click', async () => {
            try {
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();
                
                if (subscription) {
                    await subscription.unsubscribe();
                    await fetch('/api/notifications/unsubscribe', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ endpoint: subscription.endpoint })
                    });
                    updateStatus('subscription-status', 'Successfully unsubscribed from push notifications', 'success');
                    log('Successfully unsubscribed from push notifications');
                } else {
                    updateStatus('subscription-status', 'No active subscription found', 'info');
                    log('No active subscription found');
                }
            } catch (error) {
                updateStatus('subscription-status', `Error: ${error.message}`, 'error');
                log(`Error unsubscribing from push notifications: ${error.message}`, 'error');
            }
        });

        // Check subscription status
        document.getElementById('check-subscription').addEventListener('click', async () => {
            try {
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();
                
                if (subscription) {
                    updateStatus('subscription-status', 'Push subscription is active', 'success');
                    log('Push subscription is active');
                } else {
                    updateStatus('subscription-status', 'No push subscription found', 'error');
                    log('No push subscription found', 'error');
                }
            } catch (error) {
                updateStatus('subscription-status', `Error: ${error.message}`, 'error');
                log(`Error checking subscription: ${error.message}`, 'error');
            }
        });

        // Test basic notification
        document.getElementById('test-basic').addEventListener('click', () => {
            if (Notification.permission === 'granted') {
                new Notification('Test Notification', {
                    body: 'This is a test notification from the Islamic Portal',
                    icon: '/icons/icon-192x192.png'
                });
                updateStatus('notification-status', 'Basic notification sent', 'success');
                log('Basic notification sent');
            } else {
                updateStatus('notification-status', 'Notification permission not granted', 'error');
                log('Notification permission not granted', 'error');
            }
        });

        // Test prayer notification
        document.getElementById('test-prayer').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/notifications/test-immediate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    updateStatus('notification-status', 'Prayer test notification sent', 'success');
                    log('Prayer test notification sent');
                } else {
                    throw new Error('Failed to send test notification');
                }
            } catch (error) {
                updateStatus('notification-status', `Error: ${error.message}`, 'error');
                log(`Error sending prayer test notification: ${error.message}`, 'error');
            }
        });

        // Test prayer reminder
        document.getElementById('test-reminder').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/notifications/test-immediate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type: 'reminder' })
                });
                
                if (response.ok) {
                    updateStatus('notification-status', 'Prayer reminder test sent', 'success');
                    log('Prayer reminder test sent');
                } else {
                    throw new Error('Failed to send reminder test');
                }
            } catch (error) {
                updateStatus('notification-status', `Error: ${error.message}`, 'error');
                log(`Error sending reminder test: ${error.message}`, 'error');
            }
        });

        // Test audio playback
        document.getElementById('test-audio').addEventListener('click', async () => {
            try {
                const audio = document.getElementById('test-audio-player');
                const volume = document.getElementById('volume-slider').value;
                
                audio.volume = parseFloat(volume);
                await audio.play();
                
                updateStatus('audio-status', 'Audio playback started', 'success');
                log('Audio playback started');
            } catch (error) {
                updateStatus('audio-status', `Error: ${error.message}`, 'error');
                log(`Error playing audio: ${error.message}`, 'error');
            }
        });

        // Stop audio
        document.getElementById('stop-audio').addEventListener('click', () => {
            const audio = document.getElementById('test-audio-player');
            audio.pause();
            audio.currentTime = 0;
            updateStatus('audio-status', 'Audio playback stopped', 'info');
            log('Audio playback stopped');
        });

        // Clear log
        document.getElementById('clear-log').addEventListener('click', () => {
            document.getElementById('log').innerHTML = '';
        });

        // Utility function to convert VAPID key
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            log('Prayer notification test page loaded');
            
            // Check initial status
            document.getElementById('check-permission').click();
            document.getElementById('check-sw').click();
            document.getElementById('check-subscription').click();
        });
    </script>
</body>
</html>
