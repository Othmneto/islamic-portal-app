<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendar Integration Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      padding: 1rem;
      background: #0f172a;
      color: #e2e8f0;
    }
    .test-section {
      background: #1e293b;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 8px;
      border: 1px solid #334155;
    }
    .test-section h3 {
      margin-top: 0;
      color: #3b82f6;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      margin: 0.25rem;
    }
    button:hover {
      background: #2563eb;
    }
    .result {
      background: #0f172a;
      padding: 0.5rem;
      margin: 0.5rem 0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85rem;
      max-height: 300px;
      overflow-y: auto;
    }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .warning { color: #f59e0b; }
  </style>
</head>
<body>
  <h1>üóìÔ∏è Calendar Integration Test</h1>
  <p>This page tests the calendar API endpoints and functionality.</p>

  <div class="test-section">
    <h3>1. Monthly Prayer Times Service</h3>
    <button onclick="testMonthlyPrayerTimes()">Test Monthly Prayer Times</button>
    <div id="prayer-result" class="result"></div>
  </div>

  <div class="test-section">
    <h3>2. User Events CRUD</h3>
    <button onclick="testGetEvents()">Get Events</button>
    <button onclick="testCreateEvent()">Create Test Event</button>
    <button onclick="testUpdateEvent()">Update Last Event</button>
    <button onclick="testDeleteEvent()">Delete Last Event</button>
    <div id="events-result" class="result"></div>
  </div>

  <div class="test-section">
    <h3>3. Islamic Calendar</h3>
    <button onclick="testMonthlyIslamic()">Get Monthly Islamic Events</button>
    <button onclick="testCurrentHijri()">Get Current Hijri Date</button>
    <div id="islamic-result" class="result"></div>
  </div>

  <div class="test-section">
    <h3>4. OAuth Integration</h3>
    <button onclick="testOAuthStatus()">Check OAuth Status</button>
    <div id="oauth-result" class="result"></div>
  </div>

  <div class="test-section">
    <h3>5. Calendar API Client</h3>
    <button onclick="testAPIClient()">Test API Client Init</button>
    <div id="api-result" class="result"></div>
  </div>

  <script src="/js/calendar-api.js"></script>
  <script>
    let lastCreatedEventId = null;

    function log(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      const time = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
      el.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
      el.scrollTop = el.scrollHeight;
    }

    // Test 1: Monthly Prayer Times
    async function testMonthlyPrayerTimes() {
      const resultId = 'prayer-result';
      log(resultId, 'Testing monthly prayer times endpoint...', 'info');
      
      try {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        
        const response = await fetch(
          `/api/islamic-calendar/monthly-prayer-times/${year}/${month}?lat=25.2048&lon=55.2708&tz=Asia/Dubai&method=UmmAlQura&madhab=shafii`
        );
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        log(resultId, `‚úÖ Success! Loaded ${data.days?.length || 0} days`, 'success');
        log(resultId, `Sample day 1: ${JSON.stringify(data.days?.[0]?.times || {}, null, 2)}`);
      } catch (error) {
        log(resultId, `‚ùå Error: ${error.message}`, 'error');
      }
    }

    // Test 2: Events CRUD
    async function testGetEvents() {
      const resultId = 'events-result';
      log(resultId, 'Fetching user events...', 'info');
      
      try {
        const events = await window.calendarAPI.getUserEvents();
        log(resultId, `‚úÖ Loaded ${events.length} events`, 'success');
        if (events.length > 0) {
          log(resultId, `Sample: ${JSON.stringify(events[0], null, 2)}`);
        }
      } catch (error) {
        log(resultId, `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function testCreateEvent() {
      const resultId = 'events-result';
      log(resultId, 'Creating test event...', 'info');
      
      try {
        const event = {
          title: 'Calendar Integration Test Event',
          description: 'Created by integration test',
          startDate: new Date(),
          endDate: new Date(Date.now() + 60 * 60000),
          category: 'personal',
          priority: 'medium'
        };
        
        const created = await window.calendarAPI.createEvent(event);
        lastCreatedEventId = created.id;
        log(resultId, `‚úÖ Created event: ${created.id}`, 'success');
        log(resultId, JSON.stringify(created, null, 2));
      } catch (error) {
        log(resultId, `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function testUpdateEvent() {
      const resultId = 'events-result';
      
      if (!lastCreatedEventId) {
        log(resultId, '‚ö†Ô∏è Please create an event first', 'warning');
        return;
      }
      
      log(resultId, `Updating event ${lastCreatedEventId}...`, 'info');
      
      try {
        const updated = await window.calendarAPI.updateEvent(lastCreatedEventId, {
          title: 'Updated Test Event',
          description: 'Updated by integration test'
        });
        log(resultId, `‚úÖ Updated event`, 'success');
        log(resultId, JSON.stringify(updated, null, 2));
      } catch (error) {
        log(resultId, `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function testDeleteEvent() {
      const resultId = 'events-result';
      
      if (!lastCreatedEventId) {
        log(resultId, '‚ö†Ô∏è Please create an event first', 'warning');
        return;
      }
      
      log(resultId, `Deleting event ${lastCreatedEventId}...`, 'info');
      
      try {
        await window.calendarAPI.deleteEvent(lastCreatedEventId);
        log(resultId, `‚úÖ Deleted event ${lastCreatedEventId}`, 'success');
        lastCreatedEventId = null;
      } catch (error) {
        log(resultId, `‚ùå Error: ${error.message}`, 'error');
      }
    }

    // Test 3: Islamic Calendar
    async function testMonthlyIslamic() {
      const resultId = 'islamic-result';
      log(resultId, 'Fetching monthly Islamic events...', 'info');
      
      try {
        const now = new Date();
        const events = await window.calendarAPI.getMonthlyIslamicEvents(
          now.getFullYear(),
          now.getMonth() + 1,
          25.2048,
          55.2708,
          'AE'
        );
        log(resultId, `‚úÖ Loaded ${events.holidays?.length || 0} holidays, ${events.prayerEvents?.length || 0} prayer events`, 'success');
        if (events.holidays?.length > 0) {
          log(resultId, `Sample holiday: ${JSON.stringify(events.holidays[0], null, 2)}`);
        }
      } catch (error) {
        log(resultId, `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function testCurrentHijri() {
      const resultId = 'islamic-result';
      log(resultId, 'Fetching current Hijri date...', 'info');
      
      try {
        const hijri = await window.calendarAPI.getCurrentHijri();
        log(resultId, `‚úÖ Current Hijri: ${hijri.day} ${hijri.monthName} ${hijri.year} ${hijri.designation}`, 'success');
        log(resultId, JSON.stringify(hijri, null, 2));
      } catch (error) {
        log(resultId, `‚ùå Error: ${error.message}`, 'error');
      }
    }

    // Test 4: OAuth
    async function testOAuthStatus() {
      const resultId = 'oauth-result';
      log(resultId, 'Checking OAuth integration status...', 'info');
      
      try {
        const status = await window.calendarAPI.getIntegrationStatus();
        log(resultId, `‚úÖ OAuth Status Retrieved`, 'success');
        log(resultId, `Google: ${status.email?.provider?.includes('google') ? 'Connected' : 'Not connected'}`);
        log(resultId, `Microsoft: ${status.email?.provider?.includes('microsoft') ? 'Connected' : 'Not connected'}`);
        log(resultId, JSON.stringify(status, null, 2));
      } catch (error) {
        log(resultId, `‚ùå Error: ${error.message}`, 'error');
      }
    }

    // Test 5: API Client
    function testAPIClient() {
      const resultId = 'api-result';
      log(resultId, 'Testing CalendarAPI client initialization...', 'info');
      
      try {
        if (!window.calendarAPI) {
          throw new Error('CalendarAPI not found on window object');
        }
        
        const location = window.calendarAPI.getUserLocation();
        log(resultId, `‚úÖ API client initialized`, 'success');
        log(resultId, `Location: ${location.city}, ${location.country}`);
        log(resultId, `Coordinates: ${location.lat}, ${location.lon}`);
        log(resultId, `Timezone: ${location.tz}`);
        
        const prefs = window.calendarAPI.getPrayerPreferences();
        log(resultId, `Prayer preferences: method=${prefs.method}, madhab=${prefs.madhab}`);
      } catch (error) {
        log(resultId, `‚ùå Error: ${error.message}`, 'error');
      }
    }

    // Run initial test
    window.addEventListener('load', () => {
      console.log('[Calendar Test] Page loaded, API available:', !!window.calendarAPI);
      testAPIClient();
    });
  </script>
</body>
</html>

